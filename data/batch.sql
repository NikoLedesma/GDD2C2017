USE GD2C2017;
GO
IF EXISTS (SELECT name FROM sys.schemas WHERE name = 'NO_TENGO_IDEA')
BEGIN

	IF OBJECT_ID('NO_TENGO_IDEA.USUARIOXROL','U') IS NOT NULL
	DROP TABLE NO_TENGO_IDEA.USUARIOXROL;

	IF OBJECT_ID('NO_TENGO_IDEA.ROL','U') IS NOT NULL
	DROP TABLE NO_TENGO_IDEA.ROL;

	IF OBJECT_ID('NO_TENGO_IDEA.USUARIO','U') IS NOT NULL
	DROP TABLE NO_TENGO_IDEA.USUARIO;

	IF OBJECT_ID('NO_TENGO_IDEA.SP_INICIAR_SESION_DE_USUARIO','P') IS NOT NULL
	DROP PROC NO_TENGO_IDEA.SP_INICIAR_SESION_DE_USUARIO
	
	DROP SCHEMA NO_TENGO_IDEA;
END
	GO
	CREATE SCHEMA NO_TENGO_IDEA
	GO
	CREATE TABLE NO_TENGO_IDEA.ROL 
		(	
		ID INTEGER PRIMARY KEY,
		NOMBRE VARCHAR(50),
		HABILITADO BIT,
		)
	GO	
	CREATE TABLE NO_TENGO_IDEA.USUARIO 
	(
	ID INTEGER PRIMARY KEY,
	USERNAME VARCHAR(50),
	PASS VARCHAR(50),
	HABILITADO BIT,
	CANT_INTENTOS_FALLIDOS TINYINT
	)
	GO
	CREATE TABLE NO_TENGO_IDEA.USUARIOXROL 
		(
		USUARIO_ID INTEGER ,
		ROL_ID INTEGER ,
		CONSTRAINT USUARIO_ROL_PK PRIMARY KEY(USUARIO_ID,ROL_ID),
		CONSTRAINT FK_USUARIO_ROL FOREIGN KEY (USUARIO_ID) REFERENCES NO_TENGO_IDEA.USUARIO (ID),
		CONSTRAINT FK_ROL_USUARIO FOREIGN KEY (ROL_ID) REFERENCES NO_TENGO_IDEA.ROL (ID)
		)
	GO
	
	
	
	INSERT INTO  NO_TENGO_IDEA.ROL (ID,NOMBRE,HABILITADO)
	VALUES	(1,'ROL1',1), 
			(2,'ROL2',1) ,
			(3,'ROL3',1)
GO
	INSERT INTO  NO_TENGO_IDEA.USUARIO(ID,USERNAME,PASS,HABILITADO,CANT_INTENTOS_FALLIDOS)
	VALUES	(1,'USER1','USER1',1,0), 
			(2,'USER2','USER2',1,0)

GO
	INSERT INTO NO_TENGO_IDEA.USUARIOXROL (USUARIO_ID,ROL_ID)
	VALUES	(1,1),
			(1,2),
			(2,2)
GO

	/*devuelve el resultado de inicio de session.
	   1-No existe el usuario
	   2-Existe el usuario, no puede iniciar sesion por la cant de intentos fallidos
	   3-El usuario pudo iniciar sesion
	   4-El usuario ingreso mal la password, incremente la cant de intento fallidos 
	   */
	CREATE PROCEDURE NO_TENGO_IDEA.SP_INICIAR_SESION_DE_USUARIO
			@USERNAME varchar(50),
			@PASSWORD varchar(50) ,
			@ESTADO_INICIO INT OUTPUT
	AS
	DECLARE   @CANT_INTENTOS_FALLIDOS TINYINT
	IF (EXISTS(SELECT * FROM NO_TENGO_IDEA.USUARIO WHERE NO_TENGO_IDEA.USUARIO.USERNAME = @USERNAME))
	BEGIN
		SELECT @CANT_INTENTOS_FALLIDOS = CANT_INTENTOS_FALLIDOS FROM NO_TENGO_IDEA.USUARIO WHERE NO_TENGO_IDEA.USUARIO.USERNAME = @USERNAME
		IF(@CANT_INTENTOS_FALLIDOS < 3)
		BEGIN
			IF (EXISTS(SELECT * FROM NO_TENGO_IDEA.USUARIO WHERE NO_TENGO_IDEA.USUARIO.USERNAME = USERNAME AND NO_TENGO_IDEA.USUARIO.PASS = @PASSWORD))
			BEGIN
				SET @ESTADO_INICIO = 3
				UPDATE NO_TENGO_IDEA.USUARIO SET CANT_INTENTOS_FALLIDOS = 0 WHERE NO_TENGO_IDEA.USUARIO.USERNAME = @USERNAME
			END
			ELSE
			BEGIN
				SET @ESTADO_INICIO = 4
				UPDATE NO_TENGO_IDEA.USUARIO SET CANT_INTENTOS_FALLIDOS=CANT_INTENTOS_FALLIDOS + 1 WHERE NO_TENGO_IDEA.USUARIO.USERNAME = @USERNAME 
			END
		END
		ELSE
		BEGIN
			SET @ESTADO_INICIO = 2
		END	
	END
	ELSE
	BEGIN
		SET @ESTADO_INICIO=1
	END
	
	
	
	
	
	
	
	